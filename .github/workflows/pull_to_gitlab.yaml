name: Sync GitHub to GitLab

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
    
  Push_to_GitLab:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@main
        with:
            token: ${{ secrets.GH_TOKEN }}

      - name: Set up Git
        env:
            GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
            git config user.name "Lucas04"
            git config user.email "lucas04@foxmail.com"
            git config --global user.token $GITLAB_TOKEN

      - name: Set up GPG key
        env:
            GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
            echo -n ${{ secrets.GPG_PRIVATE_KEY }} | base64 -d > ./gpg_key
            gpg --import ./gpg_key
            rm ./gpg_key
            git config --global gpg.program gpg
            git config --global gpg.sign true
            git config --global user.signingkey 5F155F58DE778A7B

      - name: Push to GitLab
        env:
            GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
            git config pull.rebase false
            git remote add gitlab https://gitlab.igem.org/2024/hust-china.git
            git remote set-url gitlab https://Lucas04:vYestP-_1m6UCPwkgq6C@gitlab.igem.org/2024/hust-china.git
            # git fetch --unshallow gitlab main
            git merge -X ours --no-ff  --allow-unrelated-histories gitlab/main
            git push gitlab main

        